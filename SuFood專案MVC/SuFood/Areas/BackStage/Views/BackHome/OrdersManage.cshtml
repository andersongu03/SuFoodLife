@section Styles{
    <link href="~/css/ordersmanage.css" rel="stylesheet" />
}


<div class="orders-container col-10" id="ordersManagement">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <h4>訂單列表</h4>
    </div>

    <!-- 1.搜尋列 -->
    <div class="row mb-3">
        <div class="col-2">
            <div class="searchBar">
                <div class="inputWrapper">
                    <i class='bx bx-search-alt-2 searchIcon'></i>
                    <input type="text" class="inputSearch" placeholder="訂單編號、ID">
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="content">
                <div class="StatusBar">
                    <select>
                        <option value="all">訂購方案</option>
                        <option value="all">零售</option>
                        <option value="active">自由選</option>
                        <option value="frozen">幫你選</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="content">
                <div class="StatusBar">
                    <select>
                        <option value="all">付款狀態</option>
                        <option value="all">未付款</option>
                        <option value="active">已付款</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="content">
                <div class="StatusBar">
                    <select>
                        <option value="all">訂單狀態</option>
                        <option value="all">配送中</option>
                        <option value="active">已完成</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-4">
            <div class="content">
                <div class="date-picker">
                    <input type="date">
                    <input type="date">
                    <button>搜尋</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2.訂單-->
    <div class="general-order">
        <table class="table table-hover">
            <thead>
                <tr class="tr" >
                    <th scope="col">訂單編號</th>
                    <th scope="col">會員ID</th>
                    <th scope="col">訂購方案</th>
                    <th scope="col">付款狀態</th>
                    <th scope="col">訂單狀態</th>
                    <th scope="col">訂單明細</th>
                    <th scope="col">總金額</th>
                    <th scope="col">成立時間</th>
                    <th scope="col">收件資訊</th>
                    <th scope="col">刪除</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="o in vmOrders">
                    <td>{{o.ordersId}}</td>
                    <td>{{o.accountId}}</td>
                    <td>{{o.buyMethod}}</td>
                    <td></td>
                    <td>{{o.orderStatus}}</td>
					<td><i class='bx bx-file-find sortIcon orders-item' data-bs-toggle="modal" data-bs-target="#ordersModal" ></i></td>
                    <td>{{(o.subTotal)-(o.subDiscount)}}</td>					
                    <td>{{o.setOrdersDatetime}}</td>
                    <td><i class='bx bx bxs-edit sortIcon edit-item' data-bs-toggle="modal" data-bs-target="#editModal" @@click="editConfirm(o)"></i></td>
                    <td><i class='bx bx-trash sortIcon delete-item' data-bs-toggle="modal" data-bs-target="#deleteModal" @@click="deleteConfirm(o)"></i></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 3.分頁 -->
    <div>
        <paginate :page-count="pageCount"
                  :click-handler="changePage"
                  :prev-text="'&laquo;'"
                  :next-text="'&raquo;'"
                  :page-class="'page-item'"
                  :page-link-class="'page-link'"
                  :prev-class="'page-item'"
                  :prev-link-class="'page-link'"
                  :next-class="'page-item'"
                  :next-link-class="'page-link'"
                  :container-class="'pagination justify-content-center'">
        </paginate>
    </div>

    <!-- 4.所有Modal -->
    <!-- OrdersDetailModal -->
  @* <div class="modal fade" id="ordersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ordersDetailModal">訂單明細</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">檢視</button>
                </div>
                <div class="modal-body" id="myorders_table">
                    <!--內容-->
                    <table>
                        <thead>
                            <tr>
                                <th>訂單編號</th>
                                <th>日期</th>
                                <th>總金額</th>
                                <th>付款狀態</th>
                                <th>訂單狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in vmOrders">
                                <td>{{item.ordersId}}</td>
                                <td>{{(item.setOrdersDatetime).slice(0,10)}}</td>
                                <td>{{item.subTotal-item.subDiscount}}</td>
                                <td>{{item.customerPaymentId}}</td>  要改成付款狀態
                                <td>{{item.orderStatus}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>*@

    <!-- EditModal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModal">編輯資料</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 row">
                        <label for="type" class="col-sm-2 col-form-label">姓名</label>
                        <div class="col-sm-10">
                            <input type="text" name="name" id="name" v-model="editProfile.name" required size="4">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="price" class="col-sm-2 col-form-label">電話</label>
                        <div class="col-sm-10">
                            <input type="tel" class="form-control" id="phone" v-model="editProfile.phone" required size="10">
                        </div>
                    </div>
                     <div class="mb-3 row">
                        <label for="price" class="col-sm-2 col-form-label">地址</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="address" v-model="editProfile.address" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" >儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DeleteModal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 id="exampleModalLabel">確定要刪除編號{{delOrders.ordersId}}的訂單嗎？</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">確定</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 5.提示訊息 -->

</div>

@section Scripts{
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://unpkg.com/vuejs-paginate@0.9.0"></script>
    <script src="~/js/vue.js"></script>
    <script src="~/axios/axios.min.js"></script>
    <script>
        Vue.component('paginate', VuejsPaginate)

        const vm = new Vue({
            el: "#ordersManagement",
            data: {
                searchText:"",
                cPage:"1",
                pageItems: "7",

                vmOrders:[],
                vmDetails:[],
                vmInfo:[],

                ordersDetail:{
                    productName:"",
                    unitPrice:0,
                    quantity:0,
                    subTotal:0,
                    couponName:"",
                    subDiscount:0,
                    total:0
                },
                editProfile:{
                    ordersId:0,
                    name:"",
                    phone:"",
                    address:""                
                },
                delOrders:{
                    ordersId: "",

                }



               
               
            },
            mounted(){
                let _this = this;
				_this.getOrders();
                _this.getInfo();
            },
            methods: {
                getOrders: function(){
                    let _this = this;
                    axios.get(`/BackStage/OrdersManagement/GetAllOrders`).then(res => {
                        //alert(JSON.stringify(res.data))
                        _this.vmOrders = res.data;
                    })
                },
                //getOrdersDetails: function(){
                //    let _this = this;
                //    axios.get(`/BackStage/OrdersManagement/GetOrdersDetails`).then(res => {
                //        //alert(JSON.stringify(res.data))
                //        _this.vmDetails = res.data;
                //},
                getInfo: function(id){
                    let _this = this;
                    axios.get(`/BackStage/OrdersManagement/GetRecipientInfo?ordersId=${id}`).then(res => {
                        //alert(JSON.stringify(res.data))
                        _this.vmInfo = res.data;
                    })
                },


                editInfo: function(){
                    let _this = this;
					var request = {
                        OrdersId: this.editProfile.ordersId,
                        Name: this.editProfile.name,
                        Phone: this.editProfile.phone,
                        Address: this.editProfile.address
                    };
					axios.post(`/BackStage/OrdersManagement/EditRecipientInfo`, request).then(res => {
						$("#editModal").modal('hide'); 
						_this.getInfo();
					});               
                },
                //deleteOrder: function(){
                
                //},
    //            ordersConfirm: function (o) {
    //                 this.ordersAcc.accountId = a.accountId;
    //                 this.ordersAcc.ordersId = a.ordersId;
    //                 this.ordersAcc.date = a.setOrdersDatetime;
    //                 this.ordersAcc.total = a.subTotal;
    //                 this.ordersAcc.discount = a.subDiscount;
    //                 this.ordersAcc.payment = a.customerPaymentId; //改成付款狀態
    //                 this.ordersAcc.status = a.orderStatus;
    //                 this.getOrders();
				//},
                editConfirm: function (o) {
                    //alert(o.ordersId)
                    this.getInfo(o.ordersId)
                    this.editProfile.ordersId = o.ordersId;
                    this.editProfile.name = this.vmInfo.name;
                    this.editProfile.phone = this.vmInfo.phone;
                    this.editProfile.address = this.vmInfo.shipAddress;
				},
				deleteConfirm: function (o) {
                    this.delOrders.ordersId = o.ordersId;
				},

                changePage: function (currentpage) {
                    console.log(currentpage);
                    this.cPage = currentpage;
                },

            },
            computed: {
                pageCount:function () {
				  //return Math.ceil(this.filterSearchText.length / this.pageItems);
			      return Math.ceil(this.vmOrders.length / this.pageItems);
				},
				ordersInPage:function () {
					var max = this.cPage * this.pageItems;
					var min = this.pageItems * (this.cPage - 1) + 1;
					//return this.filterSearchText.slice(min - 1, max)
					return this.vmOrders.slice(min - 1, max)
				},
				//篩選帳號、姓名
				//filterSearchText:function(){
				//	return this.vmAccount.filter((x)=>{
				//		return x.account1.indexOf(this.searchText) !== -1 || x.firstName.indexOf(this.searchText) !== -1 || x.lastName.indexOf(this.searchText) !== -1;
				//	})
            }
        })
    </script>
}
