@section Styles{
    <link href="~/css/ordersmanage.css" rel="stylesheet" />
}


<div class="orders-container col-10" id="ordersManagement">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <h4>訂單列表</h4>
    </div>



    <!-- 1.搜尋列 -->
    <div class="row mb-3">
        <div class="col-3">
            <div class="searchBar">
                <div class="inputWrapper">
                    <i class='bx bx-search-alt-2 searchIcon'></i>
                    <input type="text" class="inputSearch" v-model="searchText" placeholder="訂單編號、ID">
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="content">
                <div class="StatusBar">
                    <select v-model="selectedMethod">
                        <option value="method">訂購方案</option>
                        <option value="retail">零售</option>
                        <option value="freechoice">自由選</option>
                        <option value="recyle">幫你選</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="content">
                <div class="StatusBar">
                    <select v-model="selectedStatus">
                        <option value="status">付款狀態</option>
                        <option value="unpaid">未付款</option>
                        <option value="paid">已付款</option>
                        <option value="canceled">已取消</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-5">
            <div class="content">
                <div class="date-picker">
                    <input id="start-date" type="date">
                    <input id="end-date" type="date">
                    <button type="button" @@click="search">搜尋</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2.訂單-->
    <div class="general-order">
        <table class="table table-hover">
            <thead>
                <tr class="tr" >
                    <th scope="col">訂單編號</th>
                    <th scope="col">會員ID</th>
                    <th scope="col">訂購方案</th>
                    <th scope="col">付款狀態</th>
                    <th scope="col">訂單明細</th>
                    <th scope="col">總金額</th>
                    <th scope="col">成立時間</th>
                    <th scope="col">評論</th>
                    <th scope="col">收件資訊</th>
                    <th scope="col">刪除</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="o in vmOrders">
                    <td>{{o.ordersId}}</td>
                    <td>{{o.accountId}}</td>
                    <td>{{o.buyMethod}}</td>
                    <td>{{o.orderStatus}}</td>
                    <td><i class='bx bx-file-find sortIcon orders-item' data-bs-toggle="modal" data-bs-target="#ordersModal" ></i></td>
                    <td>{{(o.subTotal)-(o.subDiscount)}}</td>					
                    <td>{{o.setOrdersDatetime}}</td>
                    <td><button type="button" class="btn btn-secondary" @@click="goComment(o.ordersId)">回覆</button></td>
                    <td><i class='bx bx bxs-edit sortIcon edit-item' data-bs-toggle="modal" data-bs-target="#editModal" @@click="editConfirm(o)"></i></td>
                    <td><i class='bx bx-trash sortIcon delete-item' data-bs-toggle="modal" data-bs-target="#deleteModal" @@click="deleteConfirm(o)"></i></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 3.分頁 -->
@*    <div>
        <paginate :page-count="pageCount"
                  :click-handler="changePage"
                  :prev-text="'&laquo;'"
                  :next-text="'&raquo;'"
                  :page-class="'page-item'"
                  :page-link-class="'page-link'"
                  :prev-class="'page-item'"
                  :prev-link-class="'page-link'"
                  :next-class="'page-item'"
                  :next-link-class="'page-link'"
                  :container-class="'pagination justify-content-center'">
        </paginate>
    </div>*@

    <!-- 4.所有Modal -->
    <!-- OrdersDetailModal -->
   <div class="modal fade" id="ordersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ordersDetailModal">訂單明細編號</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="myorders_table">
                    <!--內容-->
                    <table>
                        <thead>
                            <tr >
                                <th>產品名稱</th>
                                <th>單價</th>
                                <th>數量</th>
                                <th>小計</th>
                                <th>優惠券名稱</th>
                                <th>優惠券折扣</th>
                                <th>總計</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in vmDetails">
                                @*<td>{{item.productName}</td>
                                <td>{{item.unitPrice}}</td>
                                <td>{{item.quantity}}</td>
                                <td>{{item.subTotal}}</td>
                                <td>{{item.coupon.couponName}}</td>
                                <td>{{item.coupon.couponMinuCost}}</td>
                                <td>{{(item.subTotal)-(item.subDiscount)}}</td>*@
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EditModal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModal">編輯資料</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 row">
                        <label for="type" class="col-sm-2 col-form-label">姓名</label>
                        <div class="col-sm-10">
                            <input type="text" name="name" id="name" v-model="editProfile.name" required size="10">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="price" class="col-sm-2 col-form-label">電話</label>
                        <div class="col-sm-10">
                            <input type="tel" class="form-control" id="phone" v-model="editProfile.phone" required size="10">
                        </div>
                    </div>
                     <div class="mb-3 row">
                        <label for="price" class="col-sm-2 col-form-label">地址</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="address" v-model="editProfile.address" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" @@click="editInfo">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DeleteModal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 id="exampleModalLabel">確定要刪除「編號{{delOrders.ordersId}}」的訂單嗎？</h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" @@click="deleteOrder">確定</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 5.提示訊息 -->

</div>

@section Scripts{
    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://unpkg.com/vuejs-paginate@0.9.0"></script>
    <script src="~/js/vue.js"></script>
    <script src="~/axios/axios.min.js"></script>
    <script>
        Vue.component('paginate', VuejsPaginate)

        const vm = new Vue({
            el: "#ordersManagement",
            data: {
                searchText:"",
                cPage:"1",
                pageItems: "7",

                vmOrders:[],
                vmDetails:[],

                ordersDetail:{
                    productName:"",
                    unitPrice:0,
                    quantity:0,
                    subTotal:0,
                    couponName:"",
                    subDiscount:0,
                    total:0
                },
                editProfile:{
                    ordersId:0,
                    name:"",
                    phone:"",
                    address:""                
                },
                delOrders:{
                    ordersId: "",
                },                
                selectedMethod: "method",
                selectedStatus: "status",


               
               
            },
            mounted(){
                let _this = this;
				_this.getOrders();
                //_this.getOrdersDetails();
            },
            methods: {
                getOrders: function(){
                    let _this = this;
                    axios.get(`/BackStage/OrdersManagement/GetAllOrders`).then(res => {
                        //alert(JSON.stringify(res.data))
                        _this.vmOrders = res.data;
                    })
                },
                //getOrdersDetails: function(){
                //    let _this = this;
                //    axios.get(`/BackStage/OrdersManagement/GetOrdersDetails`).then(res => {
                //        alert(JSON.stringify(res.data))
                //        _this.vmDetails = res.data;
                //    })
                //},

                editInfo: function(){
                    let _this = this;
					var request = {
                        OrdersId: this.editProfile.ordersId,
                        Name: this.editProfile.name,
                        Phone: this.editProfile.phone,
                        ShipAddress: this.editProfile.address
                    };
                    axios.post(`/BackStage/OrdersManagement/EditRecipientInfo`, request).then(res => {
						$("#editModal").modal('hide');
                        _this.getOrders();
					});               
                },
                deleteOrder: function(){
                    let _this = this;
                    axios.delete(`/backstage/OrdersManagement/DeleteOrders?Id=${this.delOrders.ordersId}`).then(res => {
                        $("#deleteModal").modal("hide");
                        //_this.toast = "刪除成功";
                        //_this.toastHint();
                        _this.getOrders();
                    });
                },
                ordersConfirm: function (o) {
                     
                     
				},
                editConfirm: function (o) {
                    this.editProfile.ordersId = o.ordersId;
                    this.editProfile.name = o.name;
                    this.editProfile.phone = o.phone;
                    this.editProfile.address = o.shipAddress;
                    this.getOrders(o.ordersId);                   
				},
				deleteConfirm: function (o) {
                    this.delOrders.ordersId = o.ordersId;
				},
                changePage: function (currentpage) {
                    console.log(currentpage);
                    this.cPage = currentpage;
                },
                goComment: function (ordersId) {
                    window.location.href = "/BackStage/BackHome/CommentManagement?ordersId=" + ordersId;
                },
                search: function () {
                    var startDate = document.getElementById("start-date").value;
                    var endDate = document.getElementById("end-date").value;

                    if (endDate < startDate) {
                        alert("結束日期不得小於開始日期");
                        return; // 結束函數執行
                    }

                            //var filteredOrders = vmOrders.filter(function(order) {
                    //return order.orderDate >= startDate && order.orderDate <= endDate;
                    //});

                    //// 在這裡處理篩選後的訂單資料
                    //console.log(filteredOrders);

                    

                    console.log("Start Date: " + startDate);
                    console.log("End Date: " + endDate);
                }

            },
    //        computed: {
    //            pageCount:function () {
				//  return Math.ceil(this.filterSearchText.length / this.pageItems);
			 //     return Math.ceil(this.vmOrders.length / this.pageItems);
				//},
				//ordersInPage:function () {
				//	var max = this.cPage * this.pageItems;
				//	var min = this.pageItems * (this.cPage - 1) + 1;
				//	return this.filterSearchText.slice(min - 1, max)
				//	return this.vmOrders.slice(min - 1, max)
				//},
				//篩選訂單編號、會員ID
				filterSearchText:function(){
					//return this.vmOrders.filter((x)=>{
                    arr = this.vmOrders.filter((o)=>{
						return o.ordersId.indexOf(this.searchText) !== -1 || o.accountId.indexOf(this.searchText) !== -1 ;
					})
                    //用購買方案篩選
                    switch (this.selectedMethod) {
                        case "訂購方案":
                            break;
                        case "retail":
                            arr = this.vmOrders.filter(o => {
                            return o.buyMethod == "零售"
                            })
                            break;
                        case "freechoice":
                            arr = this.vmOrders.filter(o => {
                                return o.buyMethod == "自由選"
                            })
                            break;
                        case "recyle":
                            arr = this.vmOrders.filter(o => {
                                return o.buyMethod == "幫你選"
                            })
                    }
                    //用付款狀態篩選
                    switch (this.selectedStatus) {
                        case "status":
                            break;
                        case "unpaid":
                            arr = this.vmOrders.filter(o => {
                                return o.orderStatus == "未付款"
                            })
                            break;
                        case "paid":
                            arr = this.vmOrders.filter(o => {
                                return o.orderStatus == "已付款"
                            })
                            break;
                        case "canceled":
                            arr = this.vmOrders.filter(o => {
                                return o.orderStatus == "已取消"
                            })
                            break;
                        
                    }
                //},
                
            }

        })
    </script>
}
